<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>压力测试工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .cron-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .log-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            color: #d4d4d4;
            margin-bottom: 8px;
            line-height: 1.6;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-timestamp {
            color: #858585;
            margin-right: 10px;
        }

        .log-message {
            color: #d4d4d4;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 6px;
        }

        .clear-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .clear-btn:hover {
            background: #d32f2f;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        .curl-import {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .curl-import h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .curl-import textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .curl-import textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .curl-import-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .curl-import-btn:hover {
            background: #5568d3;
        }

        .curl-hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .task-list {
            margin-top: 20px;
        }

        .task-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .task-info {
            flex: 1;
        }

        .task-id {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .task-detail {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .task-cron {
            background: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #856404;
        }

        .task-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .task-delete-btn:hover {
            background: #d32f2f;
        }

        .task-empty {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }

        .refresh-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        /* 标签页样式 */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 日志列表样式 */
        .log-list {
            margin-top: 20px;
        }

        .log-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .log-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-title {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .log-time {
            color: #999;
            font-size: 12px;
        }

        .log-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .log-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .log-stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .log-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .log-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .log-retest-btn {
            flex: 1;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .log-retest-btn:hover {
            background: #5568d3;
        }

        .log-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .log-delete-btn:hover {
            background: #d32f2f;
        }

        .success-badge {
            color: #4caf50;
            font-weight: bold;
        }

        .failure-badge {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 压力测试工具</h1>
            <p>基于 Gin 框架的高性能负载测试系统</p>
        </div>

        <!-- 标签页导航 -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('test')">📝 压力测试</button>
            <button class="tab-btn" onclick="switchTab('logs')">📊 测试日志</button>
            <button class="tab-btn" onclick="switchTab('tasks')">⏰ 定时任务</button>
        </div>

        <!-- 压力测试页面 -->
        <div id="testTab" class="tab-content active">
        <div class="main-content">
            <div class="card">
                <h2>📝 测试配置</h2>
                
                <!-- Curl 导入区域 -->
                <div class="curl-import">
                    <h3>📋 导入 cURL 命令</h3>
                    <textarea id="curlInput" placeholder="粘贴 curl 命令，例如：&#10;curl 'https://api.example.com/endpoint' \&#10;  -H 'Authorization: Bearer token' \&#10;  -H 'Content-Type: application/json' \&#10;  --data-raw '{key  :value}'"></textarea>
                    <button type="button" class="curl-import-btn" onclick="importCurl()">🔄 解析并导入</button>
                    <div class="curl-hint">支持 bash 格式的 curl 命令，自动解析 URL、Headers、Method 和 Body</div>
                </div>

                <form id="testForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalRequests">总请求次数 *</label>
                            <input type="number" id="totalRequests" name="totalRequests" min="1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="concurrency">并发数 *</label>
                            <input type="number" id="concurrency" name="concurrency" min="1" value="10" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="method">请求方式 *</label>
                            <select id="method" name="method" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="url">请求地址 *</label>
                            <input type="url" id="url" name="url" placeholder="https://api.example.com/endpoint" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="headers">Headers (JSON格式)</label>
                        <textarea id="headers" name="headers" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'>{}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="body">Body (JSON格式)</label>
                        <textarea id="body" name="body" placeholder='{"key": "value"}'></textarea>
                    </div>

                    <div class="form-group">
                        <label>执行时间 *</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="executeType" value="immediate" checked>
                                立即执行
                            </label>
                            <label>
                                <input type="radio" name="executeType" value="scheduled">
                                定时任务
                            </label>
                        </div>
                    </div>

                    <div class="form-group hidden" id="cronGroup">
                        <label for="cronExpr">Cron 表达式</label>
                        <input type="text" id="cronExpr" name="cronExpr" placeholder="* * * * * (分 时 日 月 周)">
                        <div class="cron-hint">
                            示例: "*/5 * * * *" 每5分钟 | "0 * * * *" 每小时 | "0 0 * * *" 每天0点
                        </div>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">
                        🚀 开始测试
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>📊 实时日志</h2>
                <div class="connection-status">
                    <div>
                        <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                        <span id="statusText">未连接</span>
                    </div>
                    <button class="clear-btn" onclick="clearLogs()">清空日志</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span class="log-message">等待连接...</span>
                    </div>
                </div>
            </div>
        </div>

        </div>
        </div>

        <!-- 测试日志页面 -->
        <div id="logsTab" class="tab-content">
            <div class="card">
                <h2>📊 测试日志</h2>
                <div class="connection-status">
                    <div>
                        <span>总记录数: <strong id="logTotalCount">0</strong></span>
                    </div>
                    <button class="refresh-btn" onclick="loadLogs()">🔄 刷新</button>
                </div>
                <div class="log-list" id="logList">
                    <div class="task-empty">暂无测试记录</div>
                </div>
            </div>
        </div>

        <!-- 定时任务页面 -->
        <div id="tasksTab" class="tab-content">
            <div class="card">
                <h2>⏰ 定时任务管理</h2>
                <div class="connection-status">
                    <div>
                        <span>当前任务数: <strong id="taskCount">0</strong></span>
                    </div>
                    <button class="refresh-btn" onclick="loadTasks()">🔄 刷新</button>
                </div>
                <div class="task-list" id="taskList">
                    <div class="task-empty">暂无定时任务</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;

        // WebSocket 连接
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('statusIndicator').className = 'status-indicator status-connected';
                document.getElementById('statusText').textContent = '已连接';
                addLog('系统', '✅ WebSocket 连接成功');
                
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addLog(data.timestamp, data.message);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('statusIndicator').className = 'status-indicator status-disconnected';
                document.getElementById('statusText').textContent = '连接断开';
                addLog('系统', '❌ WebSocket 连接断开，尝试重连...');
                
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // 添加日志
        function addLog(timestamp, message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('系统', '🗑️ 日志已清空');
        }

        // 导入并解析 curl 命令
        function importCurl() {
            const curlCommand = document.getElementById('curlInput').value.trim();
            
            if (!curlCommand) {
                showNotification('请输入 curl 命令', 'error');
                return;
            }

            try {
                const parsed = parseCurlCommand(curlCommand);
                
                // 填充表单
                if (parsed.url) {
                    document.getElementById('url').value = parsed.url;
                }
                
                if (parsed.method) {
                    document.getElementById('method').value = parsed.method;
                }
                
                if (parsed.headers && Object.keys(parsed.headers).length > 0) {
                    document.getElementById('headers').value = JSON.stringify(parsed.headers, null, 2);
                }
                
                if (parsed.body) {
                    document.getElementById('body').value = parsed.body;
                }
                
                showNotification('✅ cURL 命令解析成功！', 'success');
                
                // 清空输入框
                document.getElementById('curlInput').value = '';
            } catch (error) {
                showNotification('解析失败: ' + error.message, 'error');
                console.error('Parse error:', error);
            }
        }

        // 解析 curl 命令
        function parseCurlCommand(curlCommand) {
            const result = {
                url: '',
                method: 'GET',
                headers: {},
                body: ''
            };

            // 移除换行符和多余空格，处理反斜杠续行
            let cmd = curlCommand.replace(/\\\s*\n\s*/g, ' ').replace(/\s+/g, ' ').trim();
            
            // 移除开头的 curl
            cmd = cmd.replace(/^curl\s+/i, '');

            // 提取 URL (可能被引号包围)
            const urlMatch = cmd.match(/(?:^|\s)(['"]?)([^\s'"]+\.[^\s'"]+)\1/);
            if (urlMatch) {
                result.url = urlMatch[2];
                cmd = cmd.replace(urlMatch[0], '');
            }

            // 提取 Method (-X 或 --request)
            const methodMatch = cmd.match(/(?:-X|--request)\s+(['"]?)(\w+)\1/i);
            if (methodMatch) {
                result.method = methodMatch[2].toUpperCase();
            }

            // 检查是否有 data 参数，如果有则默认为 POST
            if (cmd.match(/(?:-d|--data|--data-raw|--data-binary)/)) {
                if (!methodMatch) {
                    result.method = 'POST';
                }
            }

            // 提取 Headers (-H 或 --header)
            const headerRegex = /(?:-H|--header)\s+(['"])([^'"]+)\1/g;
            let headerMatch;
            while ((headerMatch = headerRegex.exec(cmd)) !== null) {
                const headerLine = headerMatch[2];
                const colonIndex = headerLine.indexOf(':');
                if (colonIndex > 0) {
                    const key = headerLine.substring(0, colonIndex).trim();
                    const value = headerLine.substring(colonIndex + 1).trim();
                    result.headers[key] = value;
                }
            }

            // 提取 Body (-d, --data, --data-raw, --data-binary)
            const dataMatch = cmd.match(/(?:-d|--data|--data-raw|--data-binary)\s+(['"])(.+?)\1/);
            if (dataMatch) {
                result.body = dataMatch[2];
                // 尝试格式化 JSON
                try {
                    const jsonObj = JSON.parse(result.body);
                    result.body = JSON.stringify(jsonObj, null, 2);
                } catch (e) {
                    // 不是 JSON，保持原样
                }
            }

            if (!result.url) {
                throw new Error('无法从 curl 命令中提取 URL');
            }

            return result;
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 表单提交
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                total_requests: parseInt(document.getElementById('totalRequests').value),
                concurrency: parseInt(document.getElementById('concurrency').value),
                method: document.getElementById('method').value,
                url: document.getElementById('url').value,
                execute_type: document.querySelector('input[name="executeType"]:checked').value
            };

            // 解析 Headers
            try {
                const headersText = document.getElementById('headers').value.trim();
                formData.headers = headersText ? JSON.parse(headersText) : {};
            } catch (e) {
                showNotification('Headers 格式错误，请使用有效的 JSON 格式', 'error');
                return;
            }

            // Body
            formData.body = document.getElementById('body').value.trim();

            // Cron 表达式
            if (formData.execute_type === 'scheduled') {
                formData.cron_expr = document.getElementById('cronExpr').value.trim();
                if (!formData.cron_expr) {
                    showNotification('请输入 Cron 表达式', 'error');
                    return;
                }
            }

            // 提交
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '提交中...';

            try {
                const response = await fetch('/api/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    // 如果是定时任务，刷新任务列表
                    if (formData.execute_type === 'scheduled') {
                        setTimeout(() => loadTasks(), 500);
                    }
                } else {
                    showNotification(result.error || '请求失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '🚀 开始测试';
            }
        });

        // 执行类型切换
        document.querySelectorAll('input[name="executeType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const cronGroup = document.getElementById('cronGroup');
                if (this.value === 'scheduled') {
                    cronGroup.classList.remove('hidden');
                } else {
                    cronGroup.classList.add('hidden');
                }
            });
        });

        // 加载定时任务列表
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                
                const taskList = document.getElementById('taskList');
                const taskCount = document.getElementById('taskCount');
                
                taskCount.textContent = data.count || 0;
                
                if (!data.tasks || data.tasks.length === 0) {
                    taskList.innerHTML = '<div class="task-empty">暂无定时任务</div>';
                    return;
                }
                
                taskList.innerHTML = '';
                data.tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    
                    const createdTime = new Date(task.created_at).toLocaleString('zh-CN');
                    
                    taskItem.innerHTML = `
                        <div class="task-info">
                            <div class="task-id">${task.task_id}</div>
                            <div class="task-detail">
                                <strong>${task.method}</strong> ${task.url}
                            </div>
                            <div class="task-detail">
                                Cron: <span class="task-cron">${task.cron_expr}</span> | 
                                请求数: ${task.total_requests} | 并发: ${task.concurrency} | 
                                创建时间: ${createdTime}
                            </div>
                        </div>
                        <button class="task-delete-btn" onclick="deleteTask('${task.task_id}')">🗑️ 取消</button>
                    `;
                    
                    taskList.appendChild(taskItem);
                });
            } catch (error) {
                console.error('加载任务失败:', error);
                showNotification('加载任务列表失败', 'error');
            }
        }
        
        // 删除定时任务
        async function deleteTask(taskId) {
            if (!confirm('确定要取消这个定时任务吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadTasks();
                } else {
                    showNotification(result.error || '删除失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误: ' + error.message, 'error');
            }
        }

        // 标签页切换
        function switchTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 显示选中的标签页
            if (tabName === 'test') {
                document.getElementById('testTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            } else if (tabName === 'logs') {
                document.getElementById('logsTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                loadLogs();
            } else if (tabName === 'tasks') {
                document.getElementById('tasksTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                loadTasks();
            }
        }

        // 加载测试日志
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs?page=1&page_size=50');
                const data = await response.json();

                const logList = document.getElementById('logList');
                const logTotalCount = document.getElementById('logTotalCount');

                logTotalCount.textContent = data.total || 0;

                if (!data.logs || data.logs.length === 0) {
                    logList.innerHTML = '<div class="task-empty">暂无测试记录</div>';
                    return;
                }

                logList.innerHTML = '';
                data.logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'log-item';

                    const createdTime = new Date(log.created_at).toLocaleString('zh-CN');
                    const successRate = log.total_requests > 0 ? (log.success_count / log.total_requests * 100).toFixed(2) : 0;

                    logItem.innerHTML = `
                        <div class="log-header">
                            <div class="log-title">${log.method} ${log.url}</div>
                            <div class="log-time">${createdTime}</div>
                        </div>
                        <div class="log-stats">
                            <div class="log-stat">
                                <div class="log-stat-label">总请求数</div>
                                <div class="log-stat-value">${log.total_requests}</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">成功率</div>
                                <div class="log-stat-value success-badge">${successRate}%</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">平均响应</div>
                                <div class="log-stat-value">${log.avg_response_time}ms</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">QPS</div>
                                <div class="log-stat-value">${log.requests_per_sec.toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin: 5px 0;">
                            成功: <span class="success-badge">${log.success_count}</span> | 
                            失败: <span class="failure-badge">${log.failure_count}</span> | 
                            并发: ${log.concurrency} | 
                            类型: ${log.execute_type === 'immediate' ? '立即执行' : '定时任务'}
                        </div>
                        <div class="log-actions">
                            <button class="log-retest-btn" onclick='retestFromLog(${JSON.stringify(log)})'>🔄 重新测试</button>
                            <button class="log-delete-btn" onclick="deleteLog(${log.id})">🗑️ 删除</button>
                        </div>
                    `;

                    logList.appendChild(logItem);
                });
            } catch (error) {
                console.error('加载日志失败:', error);
                showNotification('加载日志列表失败', 'error');
            }
        }

        // 从日志重新测试
        function retestFromLog(log) {
            // 切换到测试标签页
            switchTab('test');

            // 填充表单
            document.getElementById('totalRequests').value = log.total_requests;
            document.getElementById('concurrency').value = log.concurrency;
            document.getElementById('method').value = log.method;
            document.getElementById('url').value = log.url;

            // 滚动到顶部
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showNotification('已填充测试配置，可以修改后重新测试', 'success');
        }

        // 删除日志
        async function deleteLog(logId) {
            if (!confirm('确定要删除这条测试记录吗？')) {
                return;
            }

            try {
                const response = await fetch(`/api/logs/${logId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadLogs();
                } else {
                    showNotification(result.error || '删除失败', 'error');
                }
            } catch (error) {
                showNotification('网络错误: ' + error.message, 'error');
            }
        }

        // 页面加载时连接 WebSocket 并加载任务列表
        window.addEventListener('load', function() {
            connectWebSocket();
        });

        // 页面卸载时关闭 WebSocket
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
