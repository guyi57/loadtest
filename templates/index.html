<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹åŠ›æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
            font-family: 'Courier New', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: auto;
            cursor: pointer;
        }

        .cron-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .log-container {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 20px;
            height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            color: #d4d4d4;
            margin-bottom: 8px;
            line-height: 1.6;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .log-timestamp {
            color: #858585;
            margin-right: 10px;
        }

        .log-message {
            color: #d4d4d4;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .status-disconnected {
            background: #f44336;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #2d2d2d;
            border-radius: 6px;
        }

        .clear-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .clear-btn:hover {
            background: #d32f2f;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid #4caf50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
        }

        .curl-import {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #667eea;
        }

        .curl-import h3 {
            color: #667eea;
            margin-bottom: 12px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .curl-import textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .curl-import textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .curl-import-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .curl-import-btn:hover {
            background: #5568d3;
        }

        .curl-hint {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }

        .task-list {
            margin-top: 20px;
        }

        .task-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .task-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .task-info {
            flex: 1;
        }

        .task-id {
            font-weight: bold;
            color: #667eea;
            font-size: 14px;
        }

        .task-detail {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .task-cron {
            background: #fff3cd;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #856404;
        }

        .task-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .task-delete-btn:hover {
            background: #d32f2f;
        }

        .task-empty {
            text-align: center;
            color: #999;
            padding: 30px;
            font-style: italic;
        }

        .refresh-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ—¥å¿—åˆ—è¡¨æ ·å¼ */
        .log-list {
            margin-top: 20px;
        }

        .log-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .log-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-title {
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .log-time {
            color: #999;
            font-size: 12px;
        }

        .log-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 10px 0;
        }

        .log-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
        }

        .log-stat-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .log-stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .log-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .log-retest-btn {
            flex: 1;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .log-retest-btn:hover {
            background: #5568d3;
        }

        .log-delete-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .log-delete-btn:hover {
            background: #d32f2f;
        }

        .success-badge {
            color: #4caf50;
            font-weight: bold;
        }

        .failure-badge {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ å‹åŠ›æµ‹è¯•å·¥å…·</h1>
            <p>åŸºäº Gin æ¡†æ¶çš„é«˜æ€§èƒ½è´Ÿè½½æµ‹è¯•ç³»ç»Ÿ</p>
        </div>

        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('test')">ğŸ“ å‹åŠ›æµ‹è¯•</button>
            <button class="tab-btn" onclick="switchTab('logs')">ğŸ“Š æµ‹è¯•æ—¥å¿—</button>
            <button class="tab-btn" onclick="switchTab('tasks')">â° å®šæ—¶ä»»åŠ¡</button>
        </div>

        <!-- å‹åŠ›æµ‹è¯•é¡µé¢ -->
        <div id="testTab" class="tab-content active">
        <div class="main-content">
            <div class="card">
                <h2>ğŸ“ æµ‹è¯•é…ç½®</h2>
                
                <!-- Curl å¯¼å…¥åŒºåŸŸ -->
                <div class="curl-import">
                    <h3>ğŸ“‹ å¯¼å…¥ cURL å‘½ä»¤</h3>
                    <textarea id="curlInput" placeholder="ç²˜è´´ curl å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š&#10;curl 'https://api.example.com/endpoint' \&#10;  -H 'Authorization: Bearer token' \&#10;  -H 'Content-Type: application/json' \&#10;  --data-raw '{key  :value}'"></textarea>
                    <button type="button" class="curl-import-btn" onclick="importCurl()">ğŸ”„ è§£æå¹¶å¯¼å…¥</button>
                    <div class="curl-hint">æ”¯æŒ bash æ ¼å¼çš„ curl å‘½ä»¤ï¼Œè‡ªåŠ¨è§£æ URLã€Headersã€Method å’Œ Body</div>
                </div>

                <form id="testForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="totalRequests">æ€»è¯·æ±‚æ¬¡æ•° *</label>
                            <input type="number" id="totalRequests" name="totalRequests" min="1" value="100" required>
                        </div>
                        <div class="form-group">
                            <label for="concurrency">å¹¶å‘æ•° *</label>
                            <input type="number" id="concurrency" name="concurrency" min="1" value="10" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="method">è¯·æ±‚æ–¹å¼ *</label>
                            <select id="method" name="method" required>
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="url">è¯·æ±‚åœ°å€ *</label>
                            <input type="url" id="url" name="url" placeholder="https://api.example.com/endpoint" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="headers">Headers (JSONæ ¼å¼)</label>
                        <textarea id="headers" name="headers" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'>{}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="body">Body (JSONæ ¼å¼)</label>
                        <textarea id="body" name="body" placeholder='{"key": "value"}'></textarea>
                    </div>

                    <div class="form-group">
                        <label>æ‰§è¡Œæ—¶é—´ *</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="executeType" value="immediate" checked>
                                ç«‹å³æ‰§è¡Œ
                            </label>
                            <label>
                                <input type="radio" name="executeType" value="scheduled">
                                å®šæ—¶ä»»åŠ¡
                            </label>
                        </div>
                    </div>

                    <div class="form-group hidden" id="cronGroup">
                        <label for="cronExpr">Cron è¡¨è¾¾å¼</label>
                        <input type="text" id="cronExpr" name="cronExpr" placeholder="* * * * * (åˆ† æ—¶ æ—¥ æœˆ å‘¨)">
                        <div class="cron-hint">
                            ç¤ºä¾‹: "*/5 * * * *" æ¯5åˆ†é’Ÿ | "0 * * * *" æ¯å°æ—¶ | "0 0 * * *" æ¯å¤©0ç‚¹
                        </div>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">
                        ğŸš€ å¼€å§‹æµ‹è¯•
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>ğŸ“Š å®æ—¶æ—¥å¿—</h2>
                <div class="connection-status">
                    <div>
                        <span class="status-indicator status-disconnected" id="statusIndicator"></span>
                        <span id="statusText">æœªè¿æ¥</span>
                    </div>
                    <button class="clear-btn" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[--:--:--]</span>
                        <span class="log-message">ç­‰å¾…è¿æ¥...</span>
                    </div>
                </div>
            </div>
        </div>

        </div>
        </div>

        <!-- æµ‹è¯•æ—¥å¿—é¡µé¢ -->
        <div id="logsTab" class="tab-content">
            <div class="card">
                <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
                <div class="connection-status">
                    <div>
                        <span>æ€»è®°å½•æ•°: <strong id="logTotalCount">0</strong></span>
                    </div>
                    <button class="refresh-btn" onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="log-list" id="logList">
                    <div class="task-empty">æš‚æ— æµ‹è¯•è®°å½•</div>
                </div>
            </div>
        </div>

        <!-- å®šæ—¶ä»»åŠ¡é¡µé¢ -->
        <div id="tasksTab" class="tab-content">
            <div class="card">
                <h2>â° å®šæ—¶ä»»åŠ¡ç®¡ç†</h2>
                <div class="connection-status">
                    <div>
                        <span>å½“å‰ä»»åŠ¡æ•°: <strong id="taskCount">0</strong></span>
                    </div>
                    <button class="refresh-btn" onclick="loadTasks()">ğŸ”„ åˆ·æ–°</button>
                </div>
                <div class="task-list" id="taskList">
                    <div class="task-empty">æš‚æ— å®šæ—¶ä»»åŠ¡</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectInterval = null;

        // WebSocket è¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                console.log('WebSocket connected');
                document.getElementById('statusIndicator').className = 'status-indicator status-connected';
                document.getElementById('statusText').textContent = 'å·²è¿æ¥';
                addLog('ç³»ç»Ÿ', 'âœ… WebSocket è¿æ¥æˆåŠŸ');
                
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addLog(data.timestamp, data.message);
            };

            ws.onclose = function() {
                console.log('WebSocket disconnected');
                document.getElementById('statusIndicator').className = 'status-indicator status-disconnected';
                document.getElementById('statusText').textContent = 'è¿æ¥æ–­å¼€';
                addLog('ç³»ç»Ÿ', 'âŒ WebSocket è¿æ¥æ–­å¼€ï¼Œå°è¯•é‡è¿...');
                
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(connectWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(timestamp, message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-message">${message}</span>
            `;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('ç³»ç»Ÿ', 'ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…ç©º');
        }

        // å¯¼å…¥å¹¶è§£æ curl å‘½ä»¤
        function importCurl() {
            const curlCommand = document.getElementById('curlInput').value.trim();
            
            if (!curlCommand) {
                showNotification('è¯·è¾“å…¥ curl å‘½ä»¤', 'error');
                return;
            }

            try {
                const parsed = parseCurlCommand(curlCommand);
                
                // å¡«å……è¡¨å•
                if (parsed.url) {
                    document.getElementById('url').value = parsed.url;
                }
                
                if (parsed.method) {
                    document.getElementById('method').value = parsed.method;
                }
                
                if (parsed.headers && Object.keys(parsed.headers).length > 0) {
                    document.getElementById('headers').value = JSON.stringify(parsed.headers, null, 2);
                }
                
                if (parsed.body) {
                    document.getElementById('body').value = parsed.body;
                }
                
                showNotification('âœ… cURL å‘½ä»¤è§£ææˆåŠŸï¼', 'success');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('curlInput').value = '';
            } catch (error) {
                showNotification('è§£æå¤±è´¥: ' + error.message, 'error');
                console.error('Parse error:', error);
            }
        }

        // è§£æ curl å‘½ä»¤
        function parseCurlCommand(curlCommand) {
            const result = {
                url: '',
                method: 'GET',
                headers: {},
                body: ''
            };

            // ç§»é™¤æ¢è¡Œç¬¦å’Œå¤šä½™ç©ºæ ¼ï¼Œå¤„ç†åæ–œæ ç»­è¡Œ
            let cmd = curlCommand.replace(/\\\s*\n\s*/g, ' ').replace(/\s+/g, ' ').trim();
            
            // ç§»é™¤å¼€å¤´çš„ curl
            cmd = cmd.replace(/^curl\s+/i, '');

            // æå– URL (å¯èƒ½è¢«å¼•å·åŒ…å›´)
            const urlMatch = cmd.match(/(?:^|\s)(['"]?)([^\s'"]+\.[^\s'"]+)\1/);
            if (urlMatch) {
                result.url = urlMatch[2];
                cmd = cmd.replace(urlMatch[0], '');
            }

            // æå– Method (-X æˆ– --request)
            const methodMatch = cmd.match(/(?:-X|--request)\s+(['"]?)(\w+)\1/i);
            if (methodMatch) {
                result.method = methodMatch[2].toUpperCase();
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰ data å‚æ•°ï¼Œå¦‚æœæœ‰åˆ™é»˜è®¤ä¸º POST
            if (cmd.match(/(?:-d|--data|--data-raw|--data-binary)/)) {
                if (!methodMatch) {
                    result.method = 'POST';
                }
            }

            // æå– Headers (-H æˆ– --header)
            const headerRegex = /(?:-H|--header)\s+(['"])([^'"]+)\1/g;
            let headerMatch;
            while ((headerMatch = headerRegex.exec(cmd)) !== null) {
                const headerLine = headerMatch[2];
                const colonIndex = headerLine.indexOf(':');
                if (colonIndex > 0) {
                    const key = headerLine.substring(0, colonIndex).trim();
                    const value = headerLine.substring(colonIndex + 1).trim();
                    result.headers[key] = value;
                }
            }

            // æå– Body (-d, --data, --data-raw, --data-binary)
            const dataMatch = cmd.match(/(?:-d|--data|--data-raw|--data-binary)\s+(['"])(.+?)\1/);
            if (dataMatch) {
                result.body = dataMatch[2];
                // å°è¯•æ ¼å¼åŒ– JSON
                try {
                    const jsonObj = JSON.parse(result.body);
                    result.body = JSON.stringify(jsonObj, null, 2);
                } catch (e) {
                    // ä¸æ˜¯ JSONï¼Œä¿æŒåŸæ ·
                }
            }

            if (!result.url) {
                throw new Error('æ— æ³•ä» curl å‘½ä»¤ä¸­æå– URL');
            }

            return result;
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // è¡¨å•æäº¤
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                total_requests: parseInt(document.getElementById('totalRequests').value),
                concurrency: parseInt(document.getElementById('concurrency').value),
                method: document.getElementById('method').value,
                url: document.getElementById('url').value,
                execute_type: document.querySelector('input[name="executeType"]:checked').value
            };

            // è§£æ Headers
            try {
                const headersText = document.getElementById('headers').value.trim();
                formData.headers = headersText ? JSON.parse(headersText) : {};
            } catch (e) {
                showNotification('Headers æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æœ‰æ•ˆçš„ JSON æ ¼å¼', 'error');
                return;
            }

            // Body
            formData.body = document.getElementById('body').value.trim();

            // Cron è¡¨è¾¾å¼
            if (formData.execute_type === 'scheduled') {
                formData.cron_expr = document.getElementById('cronExpr').value.trim();
                if (!formData.cron_expr) {
                    showNotification('è¯·è¾“å…¥ Cron è¡¨è¾¾å¼', 'error');
                    return;
                }
            }

            // æäº¤
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                const response = await fetch('/api/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    // å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œåˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                    if (formData.execute_type === 'scheduled') {
                        setTimeout(() => loadTasks(), 500);
                    }
                } else {
                    showNotification(result.error || 'è¯·æ±‚å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸš€ å¼€å§‹æµ‹è¯•';
            }
        });

        // æ‰§è¡Œç±»å‹åˆ‡æ¢
        document.querySelectorAll('input[name="executeType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const cronGroup = document.getElementById('cronGroup');
                if (this.value === 'scheduled') {
                    cronGroup.classList.remove('hidden');
                } else {
                    cronGroup.classList.add('hidden');
                }
            });
        });

        // åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        async function loadTasks() {
            try {
                const response = await fetch('/api/tasks');
                const data = await response.json();
                
                const taskList = document.getElementById('taskList');
                const taskCount = document.getElementById('taskCount');
                
                taskCount.textContent = data.count || 0;
                
                if (!data.tasks || data.tasks.length === 0) {
                    taskList.innerHTML = '<div class="task-empty">æš‚æ— å®šæ—¶ä»»åŠ¡</div>';
                    return;
                }
                
                taskList.innerHTML = '';
                data.tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'task-item';
                    
                    const createdTime = new Date(task.created_at).toLocaleString('zh-CN');
                    
                    taskItem.innerHTML = `
                        <div class="task-info">
                            <div class="task-id">${task.task_id}</div>
                            <div class="task-detail">
                                <strong>${task.method}</strong> ${task.url}
                            </div>
                            <div class="task-detail">
                                Cron: <span class="task-cron">${task.cron_expr}</span> | 
                                è¯·æ±‚æ•°: ${task.total_requests} | å¹¶å‘: ${task.concurrency} | 
                                åˆ›å»ºæ—¶é—´: ${createdTime}
                            </div>
                        </div>
                        <button class="task-delete-btn" onclick="deleteTask('${task.task_id}')">ğŸ—‘ï¸ å–æ¶ˆ</button>
                    `;
                    
                    taskList.appendChild(taskItem);
                });
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
                showNotification('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
            }
        }
        
        // åˆ é™¤å®šæ—¶ä»»åŠ¡
        async function deleteTask(taskId) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadTasks();
                } else {
                    showNotification(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            if (tabName === 'test') {
                document.getElementById('testTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
            } else if (tabName === 'logs') {
                document.getElementById('logsTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                loadLogs();
            } else if (tabName === 'tasks') {
                document.getElementById('tasksTab').classList.add('active');
                document.querySelector('.tab-btn:nth-child(3)').classList.add('active');
                loadTasks();
            }
        }

        // åŠ è½½æµ‹è¯•æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch('/api/logs?page=1&page_size=50');
                const data = await response.json();

                const logList = document.getElementById('logList');
                const logTotalCount = document.getElementById('logTotalCount');

                logTotalCount.textContent = data.total || 0;

                if (!data.logs || data.logs.length === 0) {
                    logList.innerHTML = '<div class="task-empty">æš‚æ— æµ‹è¯•è®°å½•</div>';
                    return;
                }

                logList.innerHTML = '';
                data.logs.forEach(log => {
                    const logItem = document.createElement('div');
                    logItem.className = 'log-item';

                    const createdTime = new Date(log.created_at).toLocaleString('zh-CN');
                    const successRate = log.total_requests > 0 ? (log.success_count / log.total_requests * 100).toFixed(2) : 0;

                    logItem.innerHTML = `
                        <div class="log-header">
                            <div class="log-title">${log.method} ${log.url}</div>
                            <div class="log-time">${createdTime}</div>
                        </div>
                        <div class="log-stats">
                            <div class="log-stat">
                                <div class="log-stat-label">æ€»è¯·æ±‚æ•°</div>
                                <div class="log-stat-value">${log.total_requests}</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">æˆåŠŸç‡</div>
                                <div class="log-stat-value success-badge">${successRate}%</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">å¹³å‡å“åº”</div>
                                <div class="log-stat-value">${log.avg_response_time}ms</div>
                            </div>
                            <div class="log-stat">
                                <div class="log-stat-label">QPS</div>
                                <div class="log-stat-value">${log.requests_per_sec.toFixed(2)}</div>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: #666; margin: 5px 0;">
                            æˆåŠŸ: <span class="success-badge">${log.success_count}</span> | 
                            å¤±è´¥: <span class="failure-badge">${log.failure_count}</span> | 
                            å¹¶å‘: ${log.concurrency} | 
                            ç±»å‹: ${log.execute_type === 'immediate' ? 'ç«‹å³æ‰§è¡Œ' : 'å®šæ—¶ä»»åŠ¡'}
                        </div>
                        <div class="log-actions">
                            <button class="log-retest-btn" onclick='retestFromLog(${JSON.stringify(log)})'>ğŸ”„ é‡æ–°æµ‹è¯•</button>
                            <button class="log-delete-btn" onclick="deleteLog(${log.id})">ğŸ—‘ï¸ åˆ é™¤</button>
                        </div>
                    `;

                    logList.appendChild(logItem);
                });
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                showNotification('åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // ä»æ—¥å¿—é‡æ–°æµ‹è¯•
        function retestFromLog(log) {
            // åˆ‡æ¢åˆ°æµ‹è¯•æ ‡ç­¾é¡µ
            switchTab('test');

            // å¡«å……è¡¨å•
            document.getElementById('totalRequests').value = log.total_requests;
            document.getElementById('concurrency').value = log.concurrency;
            document.getElementById('method').value = log.method;
            document.getElementById('url').value = log.url;

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            showNotification('å·²å¡«å……æµ‹è¯•é…ç½®ï¼Œå¯ä»¥ä¿®æ”¹åé‡æ–°æµ‹è¯•', 'success');
        }

        // åˆ é™¤æ—¥å¿—
        async function deleteLog(logId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æµ‹è¯•è®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/logs/${logId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(result.message, 'success');
                    loadLogs();
                } else {
                    showNotification(result.error || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥ WebSocket å¹¶åŠ è½½ä»»åŠ¡åˆ—è¡¨
        window.addEventListener('load', function() {
            connectWebSocket();
        });

        // é¡µé¢å¸è½½æ—¶å…³é—­ WebSocket
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>
